set breakpoint pending on
set confirm off
set disassembly-flavor intel
set print pretty on
set print asm-demangle on
# disable paging
set height 0
set width 0
set pagination off
set $outside = 1
catch syscall open
commands
  set $outside = ! $outside
  if ($outside)
    i r $rax
  else
    bt 4
    x/s $rdi
  end
  continue
end
break __libc_malloc
commands
  bt
  continue
end
# malloc return
break *(__libc_malloc+188)
commands
  i r $rdx
  continue
end
# free
break __libc_free
commands
  bt
  if $rdi != 0
    x/4s $rdi
  end
  continue
end
# realloc(NULL, size) called malloc directly
break __libc_realloc if $rdi != 0
commands
  bt
  x/4s $rdi
  continue
end
# realloc return
#break malloc.c:3259
break kill
commands
  i r $r13
  continue
end
break nss_load_library
commands
  continue
end
# calloc
break __libc_calloc
commands
  bt
  continue
end
# calloc return
break malloc.c:3246
commands
  i r $rax
  continue
end
#run
continue
bt
info proc mappings
quit

